<div class="container mx-auto px-4 sm:px-4 pt-2 md:pt-8">
  <div class="flex flex-col justify-between items-start mb-4 sm:mb-6">
    <h1 class="text-4xl sm:text-5xl font-steven mb-0">Activity Feed</h1>
  </div>

  <% admin_tool do %>
    <div class="bg-soft-bone card-pixel p-1 top-4 w-fit">
      <%= video_tag asset_path("stonk_news/stonk_news_latest.mp4"), controls: true, width: 500 %>
    </div>
  <% end %>

  <% if @followed_projects.any? %>
    <div class="grid grid-cols-1 lg:grid-cols-3 gap-4 sm:gap-8 pt-2">
      <div class="lg:col-span-1">
        <div class="bg-soft-bone card-pixel p-4 sm:p-6 sticky top-4">
          <h2 class="text-2xl sm:text-3xl 2xl:text-4xl font-steven mb-4 sm:mb-6">Projects You Follow</h2>
          <div class="space-y-3 sm:space-y-4 max-h-[calc(100vh-12rem)] overflow-y-auto pr-2">
            <% @followed_projects.each do |project| %>
              <div class="transform transition-transform duration-300">
                <div class="flex items-center space-x-2 sm:space-x-4">
                  <div class="h-12 w-12 sm:h-16 sm:w-16 overflow-hidden rounded-lg flex-shrink-0">
                    <img src="<%= project.banner.presence || project.updates.find { |u| u.attachment.present? }&.attachment || "https://raw.githubusercontent.com/hackclub/dinosaurs/main/confused_dinosaur.png" %>" alt="<%= project.title %>" class="w-full h-full object-cover">
                  </div>
                  <div class="flex-grow min-w-0">
                    <h3 class="text-lg sm:text-xl 2xl:text-2xl font-steven truncate"><%= project.title %></h3>
                    <p class="text-gray-600 line-clamp-2 text-xs sm:text-sm 2xl:text-base"><%= project.description %></p>
                  </div>
                  <%= link_to project_path(project), class: "px-3 sm:px-4 py-1.5 sm:py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel flex-shrink-0" do %>
                    View
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>

      <div class="lg:col-span-2">
        <div class="bg-soft-bone card-pixel p-4 sm:p-6">
          <h2 class="text-2xl sm:text-3xl 2xl:text-4xl font-steven mb-4 sm:mb-6">Recent Updates</h2>
          <div class="space-y-4 sm:space-y-6">
            <% @recent_updates.each do |update| %>
              <div class="transform transition-transform duration-300 mb-4 sm:mb-6">
                <div class="flex items-center mb-2 sm:mb-3">
                  <% if update.user.avatar.present? %>
                    <img src="<%= update.user.avatar %>" alt="<%= update.user.display_name %>" class="w-8 h-8 sm:w-10 sm:h-10 rounded-full mr-2 sm:mr-3">
                  <% end %>
                  <div>
                    <span class="font-medium text-base sm:text-lg 2xl:text-xl"><%= update.user.display_name %></span>
                    <span class="text-gray-600 text-xs sm:text-sm 2xl:text-base ml-2"><%= time_ago_in_words(update.created_at) %> ago</span>
                  </div>
                </div>
                <div class="ml-10 sm:ml-13">
                  <h3 class="text-lg sm:text-xl 2xl:text-2xl font-steven mb-2"><%= update.project.title %></h3>
                  <div class="prose max-w-none text-gray-600 mb-2 sm:mb-3 text-sm sm:text-base 2xl:text-lg"><%= update.formatted_text %></div>
                  <% if update.attachment.present? %>
                    <div class="mt-2 sm:mt-3 overflow-hidden rounded-lg">
                      <% attachment_url = update.attachment %>
                      <% clean_url = attachment_url.gsub(/\?pub_secret=.*$/, '') %>
                      <% if clean_url.match?(/\.(jpg|jpeg|png|gif)$/i) %>
                        <img src="<%= attachment_url %>" alt="Update attachment" class="w-full h-48 sm:h-64 object-contain cursor-pointer hover:opacity-90 transition-opacity" data-action="click->image-viewer#open">
                      <% elsif clean_url.match?(/\.(mp4|webm)$/i) %>
                        <div class="h-48 sm:h-64 flex items-center justify-center bg-black">
                          <video src="<%= attachment_url %>" class="w-full h-full object-contain" playsinline controls>
                            Your browser does not support the video tag.
                          </video>
                        </div>
                      <% elsif update.attachment.match?(/\.(mp3|wavmak)$/i) %>
                        <div class="w-full h-48 sm:h-64 flex items-center justify-center">
                          <audio src="<%= update.attachment %>" class="w-[50%]" controls controlsList="nodownload">
                            Your browser does not support the audio tag.
                          </audio>
                        </div>
                      <% end %>
                    </div>
                  <% end %>
                  <%= link_to project_path(update.project), class: "mt-2 sm:mt-3 inline-block px-3 sm:px-4 py-1.5 sm:py-2 bg-nice-blue hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel" do %>
                    View Project
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      </div>
    </div>
  <% else %>
    <div class="bg-soft-bone card-pixel p-6 sm:p-12 text-center mt-8">
      <%= image_tag "puppyeyes.png", class: "mx-auto w-32 h-32 sm:w-48 sm:h-48 2xl:w-64 2xl:h-64 mb-4 sm:mb-6 transform scale-x-[-1]", alt: "Puppy Eyes" %>
      <p class="mb-6 sm:mb-8 text-black text-large sm:text-xl 2xl:text-2xl">No activity yet. Start following some projects to see their journey here!</p>
      <%= link_to explore_path, class: "px-4 sm:px-6 py-2 sm:py-3 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel" do %>
        Explore Projects
      <% end %>
    </div>
  <% end %>
</div>

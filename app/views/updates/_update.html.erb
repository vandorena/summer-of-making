<div class="bg-soft-bone card-pixel p-4 md:p-6 ml-6 md:ml-16 relative transform hover:scale-[1.02] transition-transform duration-300" id="<%= dom_id(update) %>" data-controller="modal">
    <div class="flex items-center mb-3 md:mb-4">
      <% if update.user.avatar.present? %>
        <img src="<%= update.user.avatar %>" alt="<%= update.user.display_name %>" class="w-8 h-8 md:w-10 md:h-10 rounded-full mr-2 md:mr-3">
      <% end %>
      <div>
        <span class="font-medium text-base md:text-lg"><%= update.user.display_name %></span>
        <span class="text-gray-600 text-xs md:text-sm ml-2"><%= time_ago_in_words(update.created_at) %> ago</span>
        <% if update.timer_sessions.any? %>
          <% timer_session = update.timer_sessions.first %>
          <span class="text-forest text-xs md:text-sm ml-2 block md:inline">
            <% hours = timer_session.net_time / 3600 %>
            <% minutes = (timer_session.net_time % 3600) / 60 %>
            <% seconds = timer_session.net_time % 60 %>
            <%= image_tag "hourglass.png", class: "w-4 h-4 inline-block" %> Time spent: <%= hours > 0 ? "#{hours}h " : "" %><%= minutes > 0 ? "#{minutes}m " : "" %><%= seconds > 0 ? "#{seconds}s" : "" %>
          </span>
        <% end %>
      </div>
    </div>

    <div class="prose max-w-none text-sm md:text-base 2xl:text-lg text-gray-600 mb-3 md:mb-4"><%= update.formatted_text %></div>

    <% if update.attachment.present? %>
      <div class="mt-3 md:mt-4 overflow-hidden rounded-lg">
        <% attachment_url = update.attachment %>
        <% clean_url = attachment_url.gsub(/\?pub_secret=.*$/, '') %>
        <% if clean_url.match?(/\.(jpg|jpeg|png|gif)$/i) %>
          <img src="<%= attachment_url %>"
               alt="Update attachment"
               class="w-full h-48 md:h-64 object-contain cursor-pointer hover:opacity-90 transition-opacity"
               data-action="click->image-viewer#open">
        <% elsif clean_url.match?(/\.(mp4|webm)$/i) %>
          <div class="h-48 md:h-64 flex items-center justify-center bg-black">
            <video src="<%= attachment_url %>"
                   class="w-full h-full object-contain"
                   playsinline
                   controls>
              Your browser does not support the video tag.
            </video>
          </div>
        <% elsif update.attachment.match?(/\.(mp3|wavmak)$/i) %>
          <div class="w-full h-48 md:h-64 flex items-center justify-center">
            <audio src="<%= update.attachment %>"
                   class="w-[50%]"
                   controls
                   controlsList="nodownload">
              Your browser does not support the audio tag.
            </audio>
          </div>
        <% end %>
      </div>
    <% end %>

    <div class="mt-3 md:mt-4 flex justify-end items-center space-x-4">
      <% if user_signed_in? && current_user == update.user %>
        <button data-action="click->modal#open" data-modal-id="<%= update.id %>" data-modal-type="edit" class="px-2 md:px-4 py-2 <%= @project.is_shipped? ? 'hidden' : 'bg-forest hover:scale-[1.05]' %> text-white transition-all duration-300 text-sm md:text-base 2xl:text-large btn-pixel edit-update-btn" <%= 'disabled' if @project.is_shipped? %>>
          Edit
        </button>
      <% end %>

      <button data-action="click->modal#open" data-modal-id="<%= update.id %>" data-modal-type="comment" class="px-2 md:px-4 py-2 bg-nice-blue hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel">
        Add Comment
      </button>

      <% if user_signed_in? && current_user == update.user %>
        <%= button_to "Delete", project_update_path(@project, update),
            method: :delete,
            class: "px-2 md:px-4 py-2 #{@project.is_shipped? ? 'hidden' : 'bg-vintage-red hover:scale-[1.05]'} text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel delete-button",
            data: { controller: "delete-confirmation", action: "click->delete-confirmation#confirm" },
            disabled: @project.is_shipped? %>
      <% end %>
    </div>

    <div id="comments-<%= update.id %>" class="mt-4 space-y-3">
      <%= render update.comments %>
    </div>
  </div>

  <!-- Comment Modal -->
  <div class="modal hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center p-2 md:p-4 min-h-screen" id="comment-modal-<%= update.id %>" data-controller="modal comment-modal">
    <div class="bg-soft-bone w-full max-w-2xl card-pixel mx-2 md:mx-auto relative" data-modal-target="container">
      <div class="p-3 md:p-4 border-b border-saddle-taupe border-opacity-30">
        <div class="flex justify-between items-center">
          <h3 class="text-lg md:text-2xl font-steven">Add a Comment</h3>
          <button type="button" class="text-gray-600 hover:text-vintage-red cursor-pointer" data-action="click->modal#close">
            <%= inline_svg_tag "close.svg", class: "h-6 w-6 2xl:h-8 2xl:w-8" %>
          </button>
        </div>
      </div>

      <div class="p-3 md:p-4">
        <% if user_signed_in? %>
          <% if !current_user.has_commented %>
            <div class="text-center mb-4" data-comment-modal-target="warning">
              <%= image_tag "journeypheus.png", class: "w-32 h-32 2xl:w-64 2xl:h-64 mx-auto mb-4", alt: "Journeypheus" %>
              <h4 class="text-xl md:text-2xl 2xl:text-3xl font-steven mb-2">HOLD UP</h4>
              <p class="text-base md:text-lg mb-4 text-gray-600">Be nice in the comments! <a href="https://hackclub.com/conduct/" class="text-nice-blue underline">Hack Club's Code of Conduct</a> still applies here, so don't be naughty, or Journeypheus might just come and kidnap you. <br> (& don't give Kartikey an excuse to ban :P)</p>
              <button data-action="click->comment-modal#next" class="px-2 md:px-4 py-2 bg-vintage-red hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm">
                Next
              </button>
            </div>
          <% end %>

          <div class="<%= 'hidden' unless current_user.has_commented %>" data-comment-modal-target="commentForm">
            <%= form_with model: [update, Comment.new],
                id: "comment-form-#{update.id}",
                class: "space-y-3",
                data: {
                  action: "submit->comment-modal#validateForm"
                } do |f| %>
              <div class="space-y-2">
                <%= f.text_area :text,
                    id: "text-#{update.id}",
                    class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base rounded-none",
                    rows: 4,
                    placeholder: "Write your comment here... (be nice)",
                    data: { comment_modal_target: "text" } %>
                <p class="text-xs md:text-sm text-vintage-red hidden" id="textError-#{update.id}" data-comment-modal-target="textError"></p>

              <div class="flex flex-row justify-end space-x-4">
                <button type="button" class="px-2 md:px-4 py-2 bg-vintage-red hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" data-action="click->modal#close">
                  Cancel
                </button>
                <%= f.submit "Post Comment", class: "px-2 md:px-4 py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" %>
              </div>
            <% end %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
</div>

<%# Have to keep the Edit Modal out because inside the container it gets nested inside the Comment Modal %>

<!-- Edit Update Modal -->
<% if user_signed_in? && current_user == update.user %>
  <div class="modal hidden fixed inset-0 z-50 overflow-auto bg-black bg-opacity-50 flex items-center justify-center p-2 md:p-4 min-h-screen" id="edit-modal-<%= update.id %>" data-controller="modal edit-modal">
    <div class="bg-soft-bone w-full max-w-2xl card-pixel mx-2 md:mx-auto relative" data-modal-target="container">
      <div class="p-3 md:p-4 border-b border-saddle-taupe border-opacity-30">
        <div class="flex justify-between items-center">
          <h3 class="text-lg md:text-2xl font-steven">Edit Your Update</h3>
          <button type="button" class="text-gray-600 hover:text-vintage-red cursor-pointer" data-action="click->modal#close">
            <%= inline_svg_tag "close.svg", class: "h-6 w-6 2xl:h-8 2xl:w-8" %>
          </button>
        </div>
      </div>

      <div class="p-3 md:p-4">
        <div class="text-center mb-4">
          <h4 class="text-lg md:text-xl font-steven mb-2">Edit Guidelines</h4>
          <p class="text-sm md:text-base mb-4 text-gray-600">
            You can only edit the formatting of your update (markdown, spaces, line breaks).
            <br>
            <span class="text-vintage-red">You cannot add or remove text content.</span>
          </p>
        </div>

        <%= form_with model: update,
            url: project_update_path(@project, update),
            method: :patch,
            id: "edit-form-#{update.id}",
            class: "space-y-3",
            data: {
              turbo: true,
              edit_modal_target: "form"
            } do |f| %>
          <div class="space-y-2">
            <%= f.text_area :text,
                class: "w-full px-3 py-2 border border-saddle-taupe bg-bread border-opacity-50 focus:outline-none focus:ring-forest focus:border-forest text-sm md:text-base rounded-none",
                rows: 6,
                data: { edit_modal_target: "text", original_text: update.text } %>
            <p class="text-xs md:text-sm text-vintage-red hidden edit-error-message" data-edit-modal-target="error"></p>
          </div>

          <div class="flex flex-row justify-end space-x-4">
            <button type="button" class="px-2 md:px-4 py-2 bg-vintage-red hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" data-action="click->modal#close">
              Cancel
            </button>
            <%= f.submit "Save Changes", class: "px-2 md:px-4 py-2 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-sm md:text-base 2xl:text-large btn-pixel-sm" %>
          </div>
        <% end %>
      </div>
    </div>
  </div>
<% end %>

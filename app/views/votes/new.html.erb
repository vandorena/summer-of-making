<% content_for :head do %>
  <%= preload_link_tag asset_path("allhailasc.mp3"), as: :audio %>
  <%= preload_link_tag asset_path("the_stash.mp3"), as: :audio %>
  <%= preload_link_tag asset_path("compassloading.gif"), as: :image %>

  <% if @projects.present? && @ship_events.present? %>
    <% @projects.each_with_index do |project, index| %>
      <% ship_event = @ship_events[index] %>
      <% ship_devlogs = @ship_devlogs_by_project_id[project.id] || [] %>

      <!-- Preload project banners -->
      <%= preload_link_tag url_for(project.banner), as: :image %>

      <!-- Preload user avatars -->
      <% ship_devlogs.each do |devlog| %>
        <% if devlog.user.avatar.present? && !devlog.user.avatar.blank? %>
          <%= preload_link_tag devlog.user.avatar, as: :image %>
        <% end %>

        <!-- Preload devlog attachments -->
        <% if devlog.file.attached? %>
          <% if devlog.file.image? %>
            <%= preload_link_tag url_for(devlog.file), as: :image %>
          <% elsif devlog.file.video? %>
            <%= preload_link_tag url_for(devlog.file), as: :video %>
          <% elsif devlog.file.audio? %>
            <%= preload_link_tag url_for(devlog.file), as: :audio %>
          <% end %>
        <% end %>
      <% end %>
    <% end %>
  <% end %>
<% end %>

<div class="container mx-auto px-0 sm:px-4 py-4 md:py-8" id="new-tutorial-vote-container">
  <%= render "shared/page_title",
      title: "Vote",
      subtitle: "Vote on others' projects! #{Vote.count} votes have been submitted so far!" %>
  <%# so amber doesn't have to answer the same question over and over%>
  <% if flash[:vote_rejected].present? %>
    <div id="vote-rejected-modal" data-controller="modal" class="hidden fixed inset-0 z-50 overflow-auto bg-black/30 flex items-center justify-center p-2 md:p-4" data-action="click->modal#clickOutsideHandler">
      <div class="bg-[#F3ECD8] rounded-2xl border-4 border-[#E4DCC6] w-full max-w-lg mx-2 md:mx-auto relative" data-modal-target="container">
        <div class="p-3 md:p-4 border-b border-saddle-taupe border-opacity-30">
          <div class="flex justify-between items-center">
            <h3 class="text-lg md:text-2xl">Heads up!</h3>
            <button type="button" class="text-gray-600 hover:text-vintage-red cursor-pointer transition-colors duration-200" data-action="click->modal#close">
              <%= inline_svg "icons/close.svg", class: "h-6 w-6" %>
            </button>
          </div>
        </div>
        <div class="p-3 md:p-4 space-y-3">
          <%= audio_tag "chipmunk.mp3", id: "yap-sfx", preload: "auto", class: "hidden" %>
          <div class="flex justify-center mb-2">
            <%= image_tag "rac_yap.gif", alt: "Friendly Mascot", class: "w-20 h-20 md:w-28 md:h-28 object-contain" %>
          </div>
          <p class="text-som-dark text-base">We couldn't accept that vote. No worries – a quick tune-up will get you back on track :)</p>
          <ul class="list-disc pl-5 text-sm text-gray-700 space-y-1">
            <li>Share a bit more about why you chose one project (100+ characters) and how both projects can improve.</li>
            <li>Consider technical depth, creativity, and storytelling.</li>
            <li>Peek at the demo/repo and skim the devlogs to make an informed pick.</li>
          </ul>
          <div class="pt-2">
            <%= render C::StyledButton.new(text: "Okay, I’ll improve it", css_classes: "w-full", data: { action: "click->modal#close" }) %>
          </div>
        </div>
      </div>
    </div>
    <script>
      function initializeVoteRejectedModal() {
        var modal = document.getElementById('vote-rejected-modal');
        if (!modal) return;
        modal.classList.remove('hidden');
        document.body.classList.add('overflow-hidden');
        var sfx = document.getElementById('yap-sfx');
        if (sfx) {
          try {
            sfx.volume = 0.4;
            sfx.loop = true;
            sfx.currentTime = 0;
            var p = sfx.play();
            if (p && typeof p.catch === 'function') { p.catch(function(){}) }
          } catch(e) {}
          try {
            var observer = new MutationObserver(function() {
              if (modal.classList.contains('hidden')) {
                sfx.pause();
                sfx.currentTime = 0;
                observer.disconnect();
              }
            });
            observer.observe(modal, { attributes: true, attributeFilter: ['class'] });
          } catch(e) {}
        }
      }
      document.addEventListener('DOMContentLoaded', initializeVoteRejectedModal);
      document.addEventListener('turbo:load', initializeVoteRejectedModal);
      document.addEventListener('turbo:render', initializeVoteRejectedModal);
    </script>
  <% end %>
  <% progress = current_user.votes_since_last_ship_count %>
  <% remaining = current_user.remaining_votes_to_ship %>
  <% total_active = Vote.active.where(user_id: current_user.id).count %>
  <% ships = current_user.ship_events.count %>
  <% available = [ [ progress, total_active - (ships * 20) ].max, 0 ].max %>
  <% display_done = [ available, 20 ].min %>
  <% percent = ((display_done.to_f / 20) * 100).round %>
  <% credits = current_user.ship_credits %>
  <% if remaining == 0 %>
    <div class="bg-[#F6DBBA] rounded-2xl p-3 md:p-4 mb-6 text-center">
      <% extra_rollover = [ available - 20, 0 ].max %>
      <div class="flex items-center justify-center gap-2 mb-1">
        <%= inline_svg "icons/ship.svg", class: "w-5 h-5 text-forest" %>
        <p class="text-forest text-base md:text-lg font-medium">You're ready to ship!</p>
      </div>
      <p class="text-som-detail text-xs md:text-sm"><%= pluralize(extra_rollover, 'extra vote') %> will roll over to your next ship.</p>
    </div>
  <% elsif remaining > 0 %>
    <div class=" bg-[#F6DBBA] rounded-2xl p-3 md:p-4 mb-6">
      <div class="text-center mb-2">
        <div class="flex items-center justify-center gap-2">
          <%= inline_svg "icons/ship.svg", class: "w-5 h-5 text-forest" %>
          <p class="text-som-dark text-base md:text-lg font-medium">You need <%= pluralize(remaining, "more vote") %> to ship</p>
        </div>
        <p class="text-som-detail text-xs md:text-sm mt-1">Each ship needs 20 votes; extra votes count toward your next ship.</p>
      </div>
      <div class="mx-auto max-w-md">
        <div class="h-3 bg-white/60 rounded-full border border-[#E4DCC6] overflow-hidden">
          <div class="h-full bg-forest transition-all duration-300" style="width: <%= percent %>%"></div>
        </div>
        <p class="mt-1 text-center text-som-detail text-xs md:text-sm"><%= display_done %>/20 votes</p>
      </div>
    </div>
  <% end %>

  <% if @projects.size < 2 %>
    <div class="h-full text-center mt-8">
      <p class="mb-6 sm:mb-8 text-black text-large sm:text-xl 2xl:text-2xl">There aren't enough projects in the pool to vote on. Check back later for more projects!</p>
      <%= link_to explore_path, class: "px-4 sm:px-6 py-2 sm:py-3 bg-forest hover:scale-[1.05] text-white transition-transform duration-300 text-base sm:text-lg 2xl:text-xl btn-pixel" do %>
        Explore Projects
      <% end %>
    </div>
  <% else %>
    <div class="space-y-6 sm:space-y-8">

      <div class="grid grid-cols-1 lg:grid-cols-2 gap-0 sm:gap-16 mobile-divide-dashed">
        <% @projects.each_with_index do |project, index| %>
          <% ship_event = @ship_events[index] %>
          <% ship_devlogs = (@ship_devlogs_by_project_id[project.id] || []) %>
          <% ship_time_seconds = @ship_time_seconds_by_project_id[project.id] || 0 %>
          <div class="px-4 py-8 sm:py-4 bg-[#F6DBBA] sm:rounded-xl" data-project-index="<%= index %>">
            <div class="space-y-6 sm:space-y-8">
              <div class="flex items-start gap-3 sm:gap-4">
                <div class="h-16 w-16 sm:h-20 sm:w-20 flex-shrink-0">
                  <%= image_tag project.banner, alt: project.title, class: "w-full h-full object-cover rounded-lg", loading: "lazy" %>
                  <% if project.used_ai %>
                    <div class="mt-2 flex items-center justify-center group relative">
                      <span class="inline-flex items-center bg-[#FFE8CD] text-som-dark text-xs font-semibold px-2 py-1 rounded-full border border-[#a8956b] shadow-sm">
                        Used
                        <%= inline_svg "icons/ai.svg", class: "w-5 h-5 sm:w-6 sm:h-6 ml-1" %>
                      </span>
                      <span class="absolute left-1/2 -translate-x-1/2 mt-2 w-max bg-som-dark text-[#FFE8CD] text-xs rounded px-2 py-1 opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none z-10 whitespace-nowrap shadow-lg border border-[#a8956b]">Built with help from AI models</span>
                    </div>
                  <% end %>
                </div>
                <div class="flex-grow min-w-0">
                  <h3 class="text-xl sm:text-3xl mb-1 sm:mb-2 truncate"><%= project.title %></h3>

                  <div class="flex flex-wrap items-center space-x-2 mb-2 text-sm lg:text-base 2xl:text-lg text-gray-600">
                    <span class="text-gray-800"><%= ship_devlogs.count %></span>
                    <span><%= "devlog".pluralize(ship_devlogs.count) %></span>
                    <span>•</span>
                    <span class="text-gray-800"><%= format_seconds(ship_time_seconds) %></span>
                    <% admin_tool do %>
                      <%= render "shared/project_twiddles", project: project %>
                      <span>•</span>
                      <span>Ship Date: <span class="text-black"><%= ship_event.created_at.strftime("%b %d") %></span></span>
                      <span>•</span>
                      <span>Paid: <span class="text-black"><%= @paid_ship_event_ids&.include?(ship_event.id) ? "Yes" : "No" %></span></span>
                      <span>•</span>
                      <span>Ship Event ID: <span class="text-black"><%= ship_event.id %></span></span>
                      <span>•</span>
                      <span>Project ID: <span class="text-black"><%= project.id %></span></span>
                      <span>•</span>
                      <span>Certification Status: <span class="text-black"><%= project.certification_status_text %></span></span>
                    <% end %>
                  </div>

                  <div class="text-base sm:text-lg text-gray-600"
                       data-controller="devlog-card"
                       data-devlog-card-max-length-value="150">
                    <div data-devlog-card-target="content"><%= project.description %></div>
                  </div>
                </div>
              </div>

              <div class="space-y-4 sm:space-y-6">
                <div class="grid grid-cols-1 sm:flex sm:flex-wrap justify-center gap-3 sm:gap-4">
                  <% if project.demo_link.present? %>
                    <%= render C::StyledButton.new(
                        text: "Demo",
                        link: track_demo_votes_path(position: index + 1),
                        link_target: "_blank",
                        method: :post,
                        icon: "world.svg",
                        onclick: "event.stopPropagation()",
                        id: index == 0 ? 'new-tutorial-vote-demo' : nil) %>
                  <% end %>
                  <% if project.repo_link.present? %>
                    <%= render C::StyledButton.new(
                        text: "Repository",
                        link: track_repo_votes_path(position: index + 1),
                        link_target: "_blank",
                        method: :post,
                        icon: "git.svg",
                        onclick: "event.stopPropagation()") %>
                  <% end %>

                  <%= render "shared/report", id: index == 0 ? 'new-tutorial-vote-report' : nil, suspect: ship_event, already_reported: @reported_ship_event_ids&.include?(ship_event.id) %>
                </div>
              </div>

              <div class="space-y-4 sm:space-y-8" id="<%= index == 0 ? 'new-tutorial-vote-devlogs' : nil %>">
                <% ship_devlogs.each do |devlog| %>
                  <%= render "devlogs/devlog_card",
                      devlog: devlog,
                      context: 'voting',
                      show_comments_inline: false,
                      show_comment_modal: false,
                      show_likes: false,
                      content_margin: 'p-2',
                      no_parchment: true %>
                <% end %>
              </div>
            </div>
          </div>
        <% end %>
      </div>

      <div class="mx-2 sm:mx-auto mt-8 sm:mt-12 max-w-220" id="new-tutorial-vote-decision">
        <%= render C::Container.new do %>
          <div class="p-0 sm:p-2">
            <%= render "form", vote: @vote %>
          </div>
        <% end %>
      </div>
    </div>
  <% end %>
</div>

<div id="vote-loading-overlay" class="fixed inset-0 z-50 flex items-center justify-center bg-black/40">
  <div class="bg-[#F6DBBA] rounded-2xl px-8 py-5 flex flex-col items-center gap-3 shadow-lg">
    <%= image_tag "compassloading.gif", alt: "Loading", class: "w-14 h-14 md:w-20 md:h-20 lg:w-28 lg:h-28 2xl:w-36 2xl:h-36" %>
    <p class="text-som-dark text-sm lg:text-base 2xl:text-lg">Loading…</p>
  </div>
  <script>
    (function() {
      var overlay = document.getElementById('vote-loading-overlay');
      if (!overlay) return;

      function hideOverlay() {
        if (!overlay) return;
        overlay.classList.add('hidden');
      }

      window.addEventListener('load', hideOverlay);
      document.addEventListener('turbo:render', hideOverlay);
      document.addEventListener('turbo:load', hideOverlay);

      // auto-hide after 45 in case smth is fucked up, lol
      setTimeout(hideOverlay, 45000);
    })();
  </script>
</div>

<div id="journey-music" data-turbo-permanent data-controller="music" class="fixed -bottom-28 sm:-bottom-32 -right-12 max-sm:mb-[140px]">
  <div data-music-target="speechBubble" class="absolute -top-12 -left-10 2xl:-top-16 2xl:-left-12 p-3 bg-[#F3ECD8] rounded-2xl border-4 border-[#E4DCC6] max-w-[150px] opacity-50">
    <div class="text-sm text-forest font-medium">Click me, please!</div>
  </div>
  <button
    data-music-target="toggle"
    data-action="click->music#toggleMusic"
    class="w-24 h-24 sm:w-48 sm:h-48 2xl:w-64 2xl:h-64 hover:scale-110 transition-transform duration-300 flex items-center justify-center overflow-hidden"
    title="Toggle Journey Music">
    <%= image_tag "journeypheusmusic.png", alt: "Toggle Music", class: "w-full h-full object-contain" %>

    <div data-music-target="audioTracks" class="hidden">
      <%= audio_tag "allhailasc.mp3", class: "music-track", data: { track_name: "allhailasc" } %>
      <%= audio_tag "the_stash.mp3", class: "music-track", data: { track_name: "the_stash" } %>
    </div>
  </button>
</div>

<!-- Image Viewer for Attachments -->
<div data-controller="image-viewer">
  <div data-image-viewer-target="modal" class="hidden fixed inset-0 z-50 flex items-center justify-center p-4 bg-black bg-opacity-75" data-action="click->image-viewer#closeBackground">
    <div class="relative max-w-7xl max-h-[90vh] w-full flex items-center justify-center">
      <button class="absolute top-2 right-2 md:top-4 md:right-4 text-white p-2 hover:scale-110 transition-transform z-10" data-action="image-viewer#close">
        <%= inline_svg "icons/close.svg", class: "h-6 w-6 md:h-8 md:w-8" %>
      </button>
      <img data-image-viewer-target="image" class="max-h-[85vh] max-w-full object-contain" src="" alt="Full size image">
    </div>
  </div>
</div>

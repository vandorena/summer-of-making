<%= form_with model: [:admin, ship_certification], local: true, html: { onsubmit: "return handleFormSubmit(event)" } do |f| %>
  <% project = ship_certification.project %>
  <% if ship_certification.errors.any? %>
    <div id="error_explanation">
      <h2 style="color: var(--color-red);"><%= pluralize(ship_certification.errors.count, "error") %> prohibited this ship certification from being saved:</h2>
      <ul>
        <% ship_certification.errors.full_messages.each do |message| %>
          <li style="color: var(--color-red);"><%= message %></li>
        <% end %>
      </ul>
    </div>
  <% end %>

  <div class="field" style="margin-bottom: 1.2em;">
    <b style="color: var(--color-muted);">Project:</b> <%= link_to project.title, project, style: 'color: var(--color-primary); font-weight: 600; text-decoration: underline;' %> |
    <%= link_to "View on Platform", project_path(project), target: "_blank", style: 'color: var(--color-primary); font-weight: 600; text-decoration: underline;' %><br>
    <b style="color: var(--color-muted);">User:</b> <%= project.user.display_name %> |
    <%= link_to "Admin Profile", admin_user_path(project.user), target: "_blank", style: 'color: var(--color-primary); font-weight: 600; text-decoration: underline;' %><br>
    <b style="color: var(--color-muted);">Ship Events:</b> <span style="color: var(--color-primary); font-weight: 600;"> <%= project.ship_events.size %></span><br>
    <b style="color: var(--color-muted);">Certification Type:</b> <span style="color: var(--color-primary); font-weight: 600;"> <%= project.certification_type&.humanize %></span><br>
    <b style="color: var(--color-muted);">Created:</b> <span style="color: var(--color-primary); font-weight: 600;"> <%= project.created_at.strftime("%m/%d/%Y at %I:%M %p") %></span><br>
    <b style="color: var(--color-muted);">Last Updated:</b> <span style="color: var(--color-primary); font-weight: 600;"> <%= project.updated_at.strftime("%m/%d/%Y at %I:%M %p") %></span><br>
    <i style="color: var(--color-muted); margin-top: 0.5em;">Remember, you are only testing to see "does this work as intended?" You are not checking for other things.</i>
  </div>

  <%= f.hidden_field :judgement %>

  <div class="field">
    <%= f.label :notes, nil, style: 'color: var(--color-muted); font-weight: 600;' %>
    <div style="margin: 0.8em 0; padding: 1em; background: var(--color-sheet); border-radius: 7px; border: 1px solid var(--color-border);">
      <div style="margin-bottom: 0.8em; color: var(--color-text);">
        I <select id="approval_status" onchange="updateJudgement(this.value)" style="background: var(--color-darker); border: 1px solid var(--color-border); border-radius: 4px; padding: 0.3em; color: var(--color-text); margin: 0 0.3em;">
          <option value="pending" <%= 'selected' if ship_certification.judgement.blank? || ship_certification.judgement == 'pending' %>>pending</option>
          <option value="approved" <%= 'selected' if ship_certification.judgement == 'approved' %>>approved</option>
          <option value="rejected" <%= 'selected' if ship_certification.judgement == 'rejected' %>>rejected</option>
        </select> <strong><%= project.title %></strong> because:
      </div>
      <div style="margin: 0.6em 0; color: var(--color-text);">
        <label style="display: block; margin: 0.4em 0; cursor: pointer;">
          <input type="checkbox" name="checked_demo" style="margin-right: 0.5em;"> I looked at the demo
        </label>
        <label style="display: block; margin: 0.4em 0; cursor: pointer;">
          <input type="checkbox" name="checked_repo" style="margin-right: 0.5em;"> I looked at the repo
        </label>
        <label style="display: block; margin: 0.4em 0; cursor: pointer;">
          <input type="checkbox" name="checked_description" style="margin-right: 0.5em;"> I looked at the description
        </label>
      </div>
      <div style="margin-top: 0.8em; color: var(--color-text);">
        and deemed it works as intended
      </div>
      <%= f.text_area :notes, rows: 4, placeholder: "Explain your reasoning...", style: 'padding:0.7em 1em; border-radius:7px; border:1px solid var(--color-border); background:var(--color-darker); color:var(--color-text); font-size:1em; margin-top:0.8em; min-height:100px; resize:vertical; width: 100%; box-sizing: border-box;' %>
    </div>
  </div>

  <div class="field">
    <label style="color: var(--color-muted); font-weight: 600;">Friendly Suggestion</label>
    <textarea name="improvement_suggestion" rows="3" placeholder="send the user some kind words, maybe some advice, maybe a suggestion that can take this project further in voting..." style="padding:0.7em 1em; border-radius:7px; border:1px solid var(--color-border); background:var(--color-darker); color:var(--color-text); font-size:1em; margin-bottom:0.2em; min-height:80px; resize:vertical; width: 100%; box-sizing: border-box;"></textarea>
    <small style="color: var(--color-muted); font-style: italic;">This will appear in the author's activity feed, author's can view projects you've built</small>
  </div>

  <div class="field">
    <%= f.label :proof_video, "Proof Video", style: 'color: var(--color-muted); font-weight: 600;' %>
    <%= f.file_field :proof_video, style: 'padding:0.5em 0.2em; background:var(--color-sheet); border-radius:7px; border:1px solid var(--color-border); color:var(--color-text); font-size:1em; margin-bottom:0.2em;' %>
    <% if ship_certification.proof_video.attached? %>
      <p>Current: <%= link_to ship_certification.proof_video.filename, ship_certification.proof_video, target: "_blank", style: 'color: var(--color-primary); font-weight: 600; text-decoration: underline;' %></p>
    <% end %>
  </div>

  <div class="field">
    <b style="color: var(--color-muted);">Reviewing as:</b> <span style="color: var(--color-primary); font-weight: 600;"><%= current_user.display_name %></span>
    <%= f.hidden_field :reviewer_id, value: current_user.id %>
  </div>

  <div class="actions">
    <%= f.submit "Update Ship Certification", class: 'abtn small', id: 'submit-certification' %>
  </div>
<% end %>


<script>
function updateJudgement(value) {
  const judgementField = document.getElementById('ship_certification_judgement');
  if (judgementField) {
    judgementField.value = value;
  }
  validateForm();
}

function validateForm() {
  const submitButton = document.getElementById('submit-certification');
  const approvalStatus = document.getElementById('approval_status').value;
  const demoChecked = document.querySelector('input[name="checked_demo"]').checked;
  const repoChecked = document.querySelector('input[name="checked_repo"]').checked;
  const descriptionChecked = document.querySelector('input[name="checked_description"]').checked;
  const videoField = document.querySelector('input[type="file"]');
  const hasVideo = videoField.files.length > 0 || document.querySelector('a[href*="proof_video"]');
  
  const allCheckboxesChecked = demoChecked && repoChecked && descriptionChecked;
  const statusNotPending = approvalStatus !== 'pending';
  
  if (allCheckboxesChecked && statusNotPending && hasVideo) {
    submitButton.disabled = false;
    submitButton.classList.remove('disabled');
  } else {
    submitButton.disabled = true;
    submitButton.classList.add('disabled');
  }
}

document.addEventListener('DOMContentLoaded', function() {
  const checkboxes = document.querySelectorAll('input[name^="checked_"]');
  const approvalSelect = document.getElementById('approval_status');
  const videoField = document.querySelector('input[type="file"]');
  
  checkboxes.forEach(checkbox => {
    checkbox.addEventListener('change', validateForm);
  });
  
  if (approvalSelect) {
    approvalSelect.addEventListener('change', validateForm);
  }
  
  if (videoField) {
    videoField.addEventListener('change', validateForm);
  }
  
  validateForm();
});

function showValidationPopup(missingRequirements) {
  const popup = document.getElementById('validation-popup');
  const list = document.getElementById('validation-list');
  
  list.innerHTML = '';
  missingRequirements.forEach(requirement => {
    const li = document.createElement('li');
    li.textContent = requirement;
    li.style.marginBottom = '0.3em';
    list.appendChild(li);
  });
  
  popup.style.display = 'block';
  
  setTimeout(() => {
    hideValidationPopup();
  }, 8000);
}

function hideValidationPopup() {
  const popup = document.getElementById('validation-popup');
  popup.style.display = 'none';
}


function handleFormSubmit(event) {
  const approvalStatus = document.getElementById('approval_status').value;
  const demoChecked = document.querySelector('input[name="checked_demo"]').checked;
  const repoChecked = document.querySelector('input[name="checked_repo"]').checked;
  const descriptionChecked = document.querySelector('input[name="checked_description"]').checked;
  const videoField = document.querySelector('input[type="file"]');
  const hasVideo = videoField.files.length > 0 || document.querySelector('a[href*="proof_video"]');
  
  const missingRequirements = [];
  
  if (!demoChecked) {
    missingRequirements.push('Check "I looked at the demo"');
  }
  if (!repoChecked) {
    missingRequirements.push('Check "I looked at the repo"');
  }
  if (!descriptionChecked) {
    missingRequirements.push('Check "I looked at the description"');
  }
  if (approvalStatus === 'pending') {
    missingRequirements.push('Change status from "pending" to approved or rejected');
  }
  if (!hasVideo) {
    missingRequirements.push('Upload a proof video');
  }
  
  if (missingRequirements.length > 0) {
    event.preventDefault();
    showValidationPopup(missingRequirements);
    return false;
  }
  
  return true;
}
</script>
